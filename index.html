<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR 操場定位校正版</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        .debug-panel {
            position: fixed; top: 10px; left: 10px; z-index: 999;
            background: rgba(0,0,0,0.8); color: white; padding: 15px; font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="debug-panel" id="debug">初始化 GPS...</div>

    <a-scene
        embedded
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
    >
        <a-entity id="target-container">
            <a-cylinder id="maze-wall" material="color: #00ff00; opacity: 0.8;" height="15" radius="1.5"></a-cylinder>
        </a-entity>

        <a-camera 
            gps-camera="gpsMinDistance: 1; alert: true; simulateAltitude: 1.6;" 
            rotation-reader>
        </a-camera>
    </a-scene>

    <script>
        const debug = document.getElementById('debug');
        let targetLat, targetLon;
        let hasInitialized = false;

        // 當位置改變時觸發
        window.addEventListener('gps-camera-update-position', (e) => {
            const pos = e.detail.position;
            debug.innerText = `目前位置: ${pos.latitude.toFixed(6)}, ${pos.longitude.toFixed(6)}\n狀態: 已抓取位移`;
        });

        navigator.geolocation.watchPosition((position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const acc = position.coords.accuracy;

            if (!hasInitialized && acc < 20) {
                // 初始化：把綠色柱子放在你現在位置往北 15 公尺
                // 0.00015 度約等於 15-17 公尺
                targetLat = lat + 0.00015;
                targetLon = lon;
                
                const wall = document.getElementById('maze-wall');
                wall.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLon};`);
                
                hasInitialized = true;
                console.log("目標已設定在座標:", targetLat, targetLon);
            }

            if(hasInitialized) {
                // 每秒顯示你與目標的實際距離
                const dist = calculateDistance(lat, lon, targetLat, targetLon);
                debug.innerHTML += `<br>距離目標: ${dist.toFixed(1)} 公尺\n精度: ${acc.toFixed(1)}m`;
            }
        }, (err) => {
            debug.innerText = "GPS 錯誤: " + err.message;
        }, { enableHighAccuracy: true, maximumAge: 0 });

        // 計算兩點經緯度距離的函數 (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // 地球半徑 (公尺)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    </script>
</body>
</html>
